(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{310:function(e,t,s){"use strict";s.r(t);var a=s(0),i=Object(a.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"content"},[s("h1",{attrs:{id:"getting-started-with-istio-service-mesh-part-1-deploying-istio"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#getting-started-with-istio-service-mesh-part-1-deploying-istio","aria-hidden":"true"}},[e._v("#")]),e._v(" Getting started with Istio Service Mesh - Part 1 Deploying Istio")]),e._v(" "),s("h2",{attrs:{id:"introduction-to-service-meshes"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#introduction-to-service-meshes","aria-hidden":"true"}},[e._v("#")]),e._v(" Introduction to service meshes")]),e._v(" "),s("p",[e._v("A Microservice Architecture breaks up the monolith into many smaller pieces that are composed together. Patterns to secure the communication between services like fault tolerance (via timeout, retry, circuit breaking, etc.) have been developed. A service mesh can now provide these services on a platform level and frees the application writers from those tasks. Routing decisions are done at the mesh level. Distributed tracing is used to see where calls are going in the microservice topology.")]),e._v(" "),s("h2",{attrs:{id:"prerequisites"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#prerequisites","aria-hidden":"true"}},[e._v("#")]),e._v(" Prerequisites")]),e._v(" "),s("ul",[s("li",[e._v("Install the "),s("code",[e._v("kubectl")]),e._v(" binary on your Ansible box")]),e._v(" "),s("li",[e._v("Download the UCP Client bundle for the "),s("code",[e._v("admin")]),e._v(" user. Ensure that you have configured the bundle in your terminal."),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('# cd ~/certs.hpe-ucp01.admin/\n# eval "$(<env.sh)"\nCluster "ucp_hpe-ucp01.cloudra.local:6443_admin" set.\nUser "ucp_hpe-ucp01.cloudra.local:6443_admin" set.\nContext "ucp_hpe-ucp01.cloudra.local:6443_admin" modified.\n')])])])]),e._v(" "),s("li",[e._v("Confirm that you can connect to the cluster by running a test command, for example, "),s("code",[e._v("kubectl get nodes")])])]),e._v(" "),s("h2",{attrs:{id:"installing-istio"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#installing-istio","aria-hidden":"true"}},[e._v("#")]),e._v(" Installing Istio")]),e._v(" "),s("p",[e._v("Download the installation file from the GitHub site and set up your "),s("code",[e._v("PATH")]),e._v(" variable:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('cd ~\ncurl -L https://git.io/getLatestIstio | ISTIO_VERSION=1.1.5 sh -\nexport PATH="$PATH:/root/istio-1.1.5/bin"\n')])])]),s("p",[e._v("Check that "),s("code",[e._v("istioctl")]),e._v(" is available:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('# which istioctl\n\n/root/istio-1.1.5/bin/istioctl\n\n# istioctl version\n\nversion.BuildInfo{Version:"1.1.5", GitRevision:"9b6d31b74d1c0cc9358cc82d395b53f71393326b", User:"root", Host:"3e29fde4-6c3f-11e9-b00d-0a580a2c0205", GolangVersion:"go1.10.4", DockerHub:"docker.io/istio", BuildStatus:"Clean", GitTag:"1.1.4-10-g9b6d31b"}\n')])])]),s("p",[e._v("Install all the Istio Custom Resource Definitions (CRDs) using "),s("code",[e._v("kubectl apply")]),e._v(", and wait a few seconds for the CRDs to be committed in the Kubernetes API-server:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("cd ~/istio-1.1.5\nfor i in install/kubernetes/helm/istio-init/files/crd*yaml; do kubectl apply -f $i; done\n")])])]),s("p",[e._v("Enforce mutual TLS authentication between all clients and servers.  This variant should only be used on a\nfresh Kubernetes cluster where all workloads will be Istio-enabled. All newly deployed workloads will have Istio\nsidecars installed. (If installing on an existing cluster, use the playbook "),s("code",[e._v("install/kubernetes/istio-demo.yaml")]),e._v("\nthe permissive mutual TLS mode, where all services accept both plain text and mutual TLS traffic)")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubectl apply -f install/kubernetes/istio-demo-auth.yaml\n")])])]),s("p",[e._v("You will probably see the error:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('The Service "istio-ingressgateway" is invalid: spec.ports[0].nodePort: Invalid value: 31380: provided port is not in the valid range. The range of valid ports is 32768-35535\n')])])]),s("p",[e._v("You need to modify a number of ports used so that they are in the valid range:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("find ./ -type f -exec sed -i 's/31380/33380/g' {} \\;\nfind ./ -type f -exec sed -i 's/31390/33390/g' {} \\;\nfind ./ -type f -exec sed -i 's/31400/33400/g' {} \\;\n")])])]),s("p",[e._v("Re-apply, using the modified file:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kubectl apply -f install/kubernetes/istio-demo-auth.yaml\n")])])]),s("p",[e._v("Use "),s("code",[e._v("kubectl get pods")]),e._v(" and wait until all the required pods are running:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("# kubectl get pods -n istio-system\nNAME                                      READY     STATUS      RESTARTS   AGE\ngrafana-7d46986779-8nbqv                  1/1       Running     0          12m\nistio-citadel-7476b85687-5kfcl            1/1       Running     0          12m\nistio-cleanup-secrets-m9rbp               0/1       Completed   0          13m\nistio-egressgateway-7b6b576cfc-x8mkv      1/1       Running     0          12m\nistio-galley-5d5f7f896b-5xpv4             1/1       Running     0          12m\nistio-grafana-post-install-6b4bf          0/1       Completed   3          13m\nistio-ingressgateway-7df9bdbf56-g6mtp     1/1       Running     0          12m\nistio-pilot-5dc49bbdc6-gb4sl              2/2       Running     0          12m\nistio-policy-85f58fb8b6-rgxgw             2/2       Running     0          12m\nistio-security-post-install-v72lm         0/1       Completed   2          13m\nistio-sidecar-injector-7d6d989cc8-jz7z5   1/1       Running     0          12m\nistio-telemetry-85fd5c7d97-crdbm          2/2       Running     1          12m\nistio-tracing-7bc6d6476b-h47v5            1/1       Running     0          12m\nprometheus-77bbf67664-gnv68               1/1       Running     0          12m\nservicegraph-664d5975cf-dkmkt             1/1       Running     0          12m\n")])])]),s("h2",{attrs:{id:"set-up-nodeport-for-each-service"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#set-up-nodeport-for-each-service","aria-hidden":"true"}},[e._v("#")]),e._v(" Set up NodePort for each service")]),e._v(" "),s("p",[e._v("Use "),s("code",[e._v("kubectl get svc")]),e._v(" to inspect the services:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("# kubectl get svc -n istio-system\nNAME                     TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S) \ngrafana                  ClusterIP      10.96.183.82    <none>        3000/TCP \nistio-citadel            ClusterIP      10.96.7.153     <none>        8060/TCP,15014/TCP\nistio-egressgateway      ClusterIP      10.96.12.233    <none>        80/TCP,443/TCP,15443/TCP \nistio-galley             ClusterIP      10.96.27.192    <none>        443/TCP,15014/TCP,9901/TCP\nistio-ingressgateway     LoadBalancer   10.96.26.105    <pending>     15020:33459/TCP,80:33380/TCP,443:33390/TCP,33400:33400/TCP,15029:35354/TCP,15030:35380/TCP,15031:35113/TCP,15032:34307/TCP,15443:33202/TCP\nistio-pilot              ClusterIP      10.96.179.134   <none>        15010/TCP,15011/TCP,8080/TCP,15014/TCP\nistio-policy             ClusterIP      10.96.105.251   <none>        9091/TCP,15004/TCP,15014/TCP          \nistio-sidecar-injector   ClusterIP      10.96.15.99     <none>        443/TCP           \nistio-telemetry          ClusterIP      10.96.136.207   <none>        9091/TCP,15004/TCP,15014/TCP,42422/TCP\njaeger-agent             ClusterIP      None            <none>        5775/UDP,6831/UDP,6832/UDP\njaeger-collector         ClusterIP      10.96.2.225     <none>        14267/TCP,14268/TCP      \njaeger-query             ClusterIP      10.96.15.223    <none>        16686/TCP         \nkiali                    ClusterIP      10.96.28.157    <none>        20001/TCP         \nprometheus               ClusterIP      10.96.145.238   <none>        9090/TCP          \ntracing                  ClusterIP      10.96.119.30    <none>        80/TCP            \nzipkin                   ClusterIP      10.96.245.224   <none>        9411/TCP          \n")])])]),s("p",[e._v("You can set up NodePorts to make it easier to access some of the services such as Prometheus (on port 33090), Grafana (33030), Jaeger (33086) and Kiali (33001):")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('kubectl -n istio-system patch svc prometheus   --type=\'json\' -p \'[{"op":"replace","path":"/spec/type","value":"NodePort"}]\'\nkubectl -n istio-system patch svc prometheus   --type=\'json\' -p \'[{"op": "add", "path":"/spec/ports/0/nodePort", "value":33090}]\'\nkubectl -n istio-system patch svc grafana --type=\'json\' -p \'[{"op":"replace","path":"/spec/type","value":"NodePort"}]\'\nkubectl -n istio-system patch svc grafana --type=\'json\' -p \'[{"op": "add", "path":"/spec/ports/0/nodePort", "value":33030}]\'\nkubectl -n istio-system patch svc jaeger-query --type=\'json\' -p \'[{"op":"replace","path":"/spec/type","value":"NodePort"}]\'\nkubectl -n istio-system patch svc jaeger-query --type=\'json\' -p \'[{"op": "add", "path":"/spec/ports/0/nodePort", "value":33086}]\'\nkubectl -n istio-system patch svc kiali --type=\'json\' -p \'[{"op":"replace","path":"/spec/type","value":"NodePort"}]\'\nkubectl -n istio-system patch svc kiali --type=\'json\' -p \'[{"op": "add", "path":"/spec/ports/0/nodePort", "value":33001}]\'\n')])])]),s("h2",{attrs:{id:"admission-registration"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#admission-registration","aria-hidden":"true"}},[e._v("#")]),e._v(" Admission registration")]),e._v(" "),s("p",[e._v("Verify that Kubernetes api-server supports admission registration:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("# kubectl api-versions | grep admissionregistration\n\nadmissionregistration.k8s.io/v1alpha1\nadmissionregistration.k8s.io/v1beta1\n")])])]),s("p",[e._v("Verify sidecar injector deployment:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("# kubectl -n istio-system get deployment -l istio=sidecar-injector\n\nNAME                     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nistio-sidecar-injector   1         1         1            1           22m\n")])])]),s("p",[e._v("Label the default namespace for automatic sidecar injection:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("# kubectl label namespace default istio-injection=enabled\n\nnamespace/default labeled\n")])])]),s("p",[e._v("Check that the label has been applied for the default namespace:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("# kubectl get namespace -L istio-injection\n\nNAME           STATUS    AGE       ISTIO-INJECTION\ndefault        Active    2d        enabled\nistio-system   Active    22m       disabled\nkube-public    Active    2d\nkube-system    Active    2d\n")])])]),s("p",[e._v("Now you are ready to install the reference BookInfo application for Istio.")])])}],!1,null,null,null);i.options.__file="istio-getting-started-1.md";t.default=i.exports}}]);